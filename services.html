<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Mithila System 5.0 (Ultimate)</title>
    <style>
        :root { --orange: #FF9933; --white: #ffffff; --green: #138808; --blue: #000080; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        /* --- TIRANGA BACKGROUND & ANIMATION --- */
        body {
            background: linear-gradient(180deg, var(--orange) 0%, var(--white) 35%, var(--white) 65%, var(--green) 100%);
            min-height: 100vh;
            padding-bottom: 60px;
            overflow-x: hidden;
            position: relative;
        }
        .chakra-bg {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 300px; height: 300px;
            opacity: 0.2;
            z-index: -1;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23000080' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cpath d='M12 2v20M2 12h20M4.93 4.93l14.14 14.14M19.07 4.93L4.93 19.07M12 12l2.5-4.33M12 12l-2.5-4.33M12 12l4.33 2.5M12 12l-4.33 2.5M12 12l4.33-2.5M12 12l-4.33-2.5M12 12l2.5 4.33M12 12l-2.5 4.33'/%3E%3C/svg%3E");
            background-size: cover;
            animation: spin 20s linear infinite;
        }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* --- LAYOUT --- */
        .container { max-width: 500px; margin: auto; padding: 15px; position: relative; z-index: 10; }
        .box { background: rgba(255,255,255,0.96); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-bottom: 15px; display: none; border: 2px solid var(--blue); }
        #box-login { display: block; }

        .admin-wide { max-width: 1000px; background: white; padding: 20px; margin: 10px auto; border-radius: 10px; display: none; border-top: 5px solid var(--orange); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        h2, h3 { text-align: center; color: var(--blue); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        label { font-size: 12px; font-weight: bold; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; outline: none; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 25px; color: white; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 15px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-blue { background: var(--blue); } 
        .btn-green { background: var(--green); } 
        .btn-orange { background: var(--orange); }
        .btn-red { background: #dc3545; }
        .link-btn { color: var(--blue); cursor: pointer; font-size: 13px; text-decoration: underline; background: none; border: none; padding: 0; }

        .nav-tabs { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .nav-btn { padding: 8px 15px; border: none; background: #eee; border-radius: 20px; white-space: nowrap; cursor: pointer; font-size: 13px; font-weight: bold; color: #333; }
        .nav-btn.active { background: var(--blue); color: white; }

        .chat-box { height: 300px; overflow-y: auto; background: #e5ddd5; padding: 10px; border-radius: 8px; border: 1px solid #ddd; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 75%; font-size: 14px; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: #dcf8c6; } 
        .msg.other { align-self: flex-start; background: white; }
        
        .card-list { display: flex; flex-direction: column; gap: 10px; }
        .card-item { background: #f9f9f9; padding: 10px; border-radius: 5px; border-left: 4px solid var(--orange); display: flex; justify-content: space-between; align-items: center; }

        #cam_preview { width: 100%; height: 250px; background: black; border-radius: 10px; display: none; }
        #cam_canvas { display: none; }
        .punch-status { text-align: center; font-weight: bold; margin: 10px 0; }
        .status-present { color: var(--green); }
        .status-absent { color: red; }
        .hidden { display: none !important; }
        #recaptcha-container { margin: 10px auto; }
        
        .toggle-login { display:flex; justify-content:center; gap:10px; margin-bottom:10px; }
        .toggle-btn { padding:5px 10px; border:1px solid var(--blue); border-radius:15px; font-size:12px; cursor:pointer; }
        .toggle-btn.sel { background:var(--blue); color:white; }
    </style>
</head>
<body>

    <div class="chakra-bg"></div>

    <div class="container">
        <div id="box-login" class="box">
            <h2>üîê Login</h2>
            <div class="nav-tabs" style="justify-content: center;">
                <button class="nav-btn active" onclick="showLoginTab('login-user')">User</button>
                <button class="nav-btn" onclick="showLoginTab('login-emp')">Employee</button>
                <button class="nav-btn" onclick="showLoginTab('login-admin')">Admin</button>
            </div>

            <div id="login-user" class="l-sec">
                <div class="toggle-login">
                    <div class="toggle-btn sel" onclick="toggleMethod('u', 'pass', this)">Password</div>
                    <div class="toggle-btn" onclick="toggleMethod('u', 'otp', this)">OTP</div>
                </div>

                <input type="text" id="l_u_phone" placeholder="Mobile Number">
                
                <div id="u_pass_area">
                    <input type="password" id="l_u_pass" placeholder="Password">
                    <button class="btn btn-blue" onclick="loginUser('pass')">Login</button>
                    <div style="text-align:right; margin-top:5px;">
                        <button class="link-btn" onclick="startForgot('user')">Forgot Password?</button>
                    </div>
                </div>

                <div id="u_otp_area" class="hidden">
                    <button class="btn btn-blue" id="btn_u_otp_send" onclick="sendLoginOTP('user')">Send OTP</button>
                    <div id="u_otp_verify" class="hidden">
                        <input type="number" id="l_u_otp_code" placeholder="Enter OTP">
                        <button class="btn btn-green" onclick="loginUser('otp')">Verify & Login</button>
                    </div>
                </div>
                
                <p style="text-align:center; margin-top:15px; font-size:13px;">
                    <span onclick="go('box-reg')" style="color:var(--orange); cursor:pointer; font-weight:bold;">New User? Register Here</span>
                </p>
            </div>

            <div id="login-emp" class="l-sec hidden">
                <div class="toggle-login">
                    <div class="toggle-btn sel" onclick="toggleMethod('e', 'pass', this)">ID & Password</div>
                    <div class="toggle-btn" onclick="toggleMethod('e', 'otp', this)">ID & OTP</div>
                </div>

                <input type="text" id="l_e_phone" placeholder="Employee Mobile (ID)">

                <div id="e_pass_area">
                    <input type="password" id="l_e_pass" placeholder="Password">
                    <button class="btn btn-green" onclick="loginEmp('pass')">Login</button>
                    <div style="text-align:right; margin-top:5px;">
                        <button class="link-btn" onclick="startForgot('employee')">Forgot Password?</button>
                    </div>
                </div>

                <div id="e_otp_area" class="hidden">
                    <button class="btn btn-green" id="btn_e_otp_send" onclick="sendLoginOTP('employee')">Send OTP</button>
                    <div id="e_otp_verify" class="hidden">
                        <input type="number" id="l_e_otp_code" placeholder="Enter OTP">
                        <button class="btn btn-green" onclick="loginEmp('otp')">Verify & Login</button>
                    </div>
                </div>
            </div>

            <div id="login-admin" class="l-sec hidden">
                <input type="text" id="l_a_id" placeholder="Admin ID">
                <input type="password" id="l_a_pass" placeholder="Admin Password">
                <button class="btn btn-orange" onclick="loginAdmin()">Login Admin</button>
            </div>

            <div id="recaptcha-container"></div>
        </div>

        <div id="box-forgot" class="box">
            <h2>üîë Reset Password</h2>
            <p style="text-align:center; margin-bottom:10px;">For: <span id="forgot_role_disp" style="font-weight:bold;"></span></p>
            
            <input type="text" id="f_phone" placeholder="Enter Registered Mobile">
            
            <div id="f_otp_sec" class="hidden">
                <input type="number" id="f_otp" placeholder="Enter OTP">
                <button class="btn btn-green" onclick="verifyForgotOTP()">Verify OTP</button>
            </div>

            <div id="f_new_pass_sec" class="hidden">
                <input type="password" id="f_new_pass" placeholder="New Password">
                <button class="btn btn-blue" onclick="updatePassword()">Set Password</button>
            </div>

            <button class="btn btn-blue" id="btn_f_send" onclick="sendForgotOTP()">Send OTP</button>
            <button class="btn" style="background:#888;" onclick="go('box-login')">Cancel</button>
        </div>

        <div id="box-reg" class="box">
            <h2>üìù User Registration</h2>
            <input type="text" id="r_name" placeholder="Full Name">
            <input type="date" id="r_dob">
            <input type="email" id="r_email" placeholder="Email ID">
            <input type="number" id="r_phone" placeholder="Mobile Number (10 Digit)">
            
            <div id="r_otp_sec" class="hidden" style="background:#f0f0f0; padding:10px; border-radius:5px; margin-bottom:10px;">
                <label style="color:var(--green);">OTP Sent!</label>
                <input type="number" id="r_otp_code" placeholder="Enter 6-digit OTP">
                <button class="btn btn-green" onclick="verifyRegOTP()">Verify & Register</button>
                <button class="btn btn-outline" id="btn_resend" onclick="sendRegOTP()" disabled style="background:none; color:#555; font-size:12px; margin-top:5px;">Resend OTP (60s)</button>
            </div>

            <button class="btn btn-blue" id="btn_r_send" onclick="sendRegOTP()">Send OTP</button>
            
            <div id="r_pass_sec" class="hidden">
                <label>Set Password:</label>
                <input type="password" id="r_pass" placeholder="Create Password">
                <button class="btn btn-blue" onclick="finalizeReg()">Finish</button>
            </div>
            <button class="btn" style="background:#888;" onclick="go('box-login')">Back</button>
        </div>

        <div id="box-user" class="box">
            <h3 id="u_wel_msg">Welcome User</h3>
            <div class="nav-tabs">
                <button class="nav-btn active" onclick="uTab('u-shop')">Shop</button>
                <button class="nav-btn" onclick="uTab('u-chat')">Chat Admin</button>
                <button class="nav-btn" onclick="uTab('u-media')">Feed</button>
            </div>
            <div id="u-shop" class="u-sec">
                <p>Welcome to Mithila Shop.</p>
                <button class="btn btn-green">View Products</button>
            </div>
            <div id="u-chat" class="u-sec hidden">
                <div class="chat-box" id="u_chat_disp"></div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="text" id="u_msg_in" placeholder="Type message...">
                    <button class="btn-blue" style="width:50px;" onclick="sendChat('user')">‚û§</button>
                </div>
            </div>
            <div id="u-media" class="u-sec hidden">
                <div id="u_feed_disp"></div>
            </div>
            <button class="btn btn-red" onclick="location.reload()">Logout</button>
        </div>

        <div id="box-emp" class="box">
            <h3 id="e_wel_msg">Employee Panel</h3>
            <div class="nav-tabs">
                <button class="nav-btn active" onclick="eTab('e-att')">Attendance</button>
                <button class="nav-btn" onclick="eTab('e-work')">Work Report</button>
            </div>

            <div id="e-att" class="e-sec">
                <div class="punch-status" id="e_today_status">Checking Status...</div>
                <div id="camera_area" class="hidden">
                    <video id="cam_preview" autoplay playsinline></video>
                    <canvas id="cam_canvas"></canvas>
                    <button class="btn btn-green" id="btn_capture" onclick="captureAndPunch()">üì∏ Click & Punch In</button>
                </div>
                <button class="btn btn-blue" id="btn_start_cam" onclick="startCamera()">Start Face Punching</button>
            </div>

            <div id="e-work" class="e-sec hidden">
                <textarea id="e_report_txt" rows="4" placeholder="Type your daily work report here..."></textarea>
                <button class="btn btn-orange" onclick="sendReport()">Submit Report</button>
            </div>
            <button class="btn btn-red" onclick="location.reload()">Logout</button>
        </div>
    </div>

    <div id="box-admin" class="admin-wide">
        <h2>üõ†Ô∏è Admin Control Center</h2>
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="aTab('a-emp')">Employees</button>
            <button class="nav-btn" onclick="aTab('a-att')">Attendance</button>
            <button class="nav-btn" onclick="aTab('a-chat')">User Chat</button>
            <button class="nav-btn" onclick="aTab('a-media')">Uploads</button>
        </div>

        <div id="a-emp" class="a-sec">
            <h4>Add New Employee</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="text" id="new_e_name" placeholder="Emp Name">
                <input type="text" id="new_e_phone" placeholder="Emp Mobile">
                <input type="password" id="new_e_pass" placeholder="Set Password">
                <input type="text" id="new_e_role" placeholder="Role (e.g. Sales)" value="Staff">
            </div>
            <button class="btn btn-green" onclick="addEmployee()">Add Employee</button>
            <hr style="margin:15px 0;">
            <h4>Employee List</h4>
            <div id="adm_emp_list" class="card-list"></div>
        </div>

        <div id="a-att" class="a-sec hidden">
            <h4>Today's Attendance (<span id="today_date"></span>)</h4>
            <div id="adm_att_list" class="card-list"></div>
        </div>

        <div id="a-chat" class="a-sec hidden">
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
                <div>
                    <h4>Users</h4>
                    <div id="adm_user_list" style="height:300px; overflow-y:auto; background:#eee; padding:5px;"></div>
                </div>
                <div>
                    <h4 id="chat_head_nm">Select User</h4>
                    <div class="chat-box" id="adm_chat_disp"></div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input type="text" id="a_msg_in" placeholder="Reply...">
                        <button class="btn-blue" style="width:50px;" onclick="sendChat('admin')">‚û§</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="a-media" class="a-sec hidden">
            <h4>Upload Media</h4>
            <select id="m_type">
                <option value="text">Notice (Text)</option>
                <option value="video">Video (YouTube URL)</option>
                <option value="photo">Photo (URL)</option>
            </select>
            <input type="text" id="m_title" placeholder="Title/Caption">
            <input type="text" id="m_url" placeholder="Paste Link Here">
            <button class="btn btn-orange" onclick="postMedia()">Upload to Feed</button>
            <hr>
            <div id="adm_post_list"></div>
        </div>
        <button class="btn btn-red" onclick="location.reload()" style="max-width:200px; margin:20px auto; display:block;">Logout Admin</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBtLLOyVgt5hQwxokdsSRkeArZab5kyr_Q",
            authDomain: "mithilahelp-4107d.firebaseapp.com",
            databaseURL: "https://mithilahelp-4107d-default-rtdb.firebaseio.com",
            projectId: "mithilahelp-4107d",
            storageBucket: "mithilahelp-4107d.firebasestorage.app",
            messagingSenderId: "525345376934",
            appId: "1:525345376934:web:7083c7cecccd26a4a78267"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentUser = null; 
        let confirmationResult = null;
        let activeChatUser = null;
        let resendTimer = 60;
        let timerInterval = null;
        let forgotRole = null; // 'user' or 'employee'

        window.onload = function() {
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {'size': 'invisible'});
            document.getElementById('today_date').innerText = new Date().toLocaleDateString();
        };

        function go(id) { document.querySelectorAll('.box, .admin-wide').forEach(e => e.style.display = 'none'); document.getElementById(id).style.display = 'block'; }
        
        function showLoginTab(id) {
            document.querySelectorAll('.l-sec').forEach(e => e.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(id).classList.remove('hidden');
        }

        function toggleMethod(prefix, type, el) {
            el.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('sel'));
            el.classList.add('sel');
            if(type === 'pass') {
                document.getElementById(prefix + '_pass_area').classList.remove('hidden');
                document.getElementById(prefix + '_otp_area').classList.add('hidden');
            } else {
                document.getElementById(prefix + '_pass_area').classList.add('hidden');
                document.getElementById(prefix + '_otp_area').classList.remove('hidden');
            }
        }

        // --- NEW ADMIN LOGIN ---
        function loginAdmin() {
            let id = document.getElementById('l_a_id').value;
            let pa = document.getElementById('l_a_pass').value;
