<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Mithila Super System 3.0 (OTP)</title>
    <style>
        :root { --orange: #FF9933; --green: #138808; --blue: #007BFF; --red: #dc3545; --chat-bg: #e5ddd5; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f0f2f5; padding-bottom: 60px; }
        
        .container { max-width: 500px; margin: auto; padding: 10px; }
        .box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; display: none; }
        #box-login { display: block; }

        .admin-wide { max-width: 1000px; background: white; padding: 20px; margin: 10px auto; border-radius: 10px; display: none; border-top: 5px solid var(--orange); }

        h2, h3 { text-align: center; color: var(--green); margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 25px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.3s; }
        .btn:active { transform: scale(0.98); }
        .btn-blue { background: var(--blue); } .btn-green { background: var(--green); } .btn-red { background: var(--red); }
        .btn-outline { background: transparent; border: 1px solid var(--blue); color: var(--blue); margin-top: 5px; }

        /* Login Toggle Tabs */
        .login-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .l-tab { flex: 1; padding: 10px; text-align: center; background: #eee; cursor: pointer; border-radius: 5px; font-size: 14px; }
        .l-tab.active { background: var(--blue); color: white; font-weight: bold; }

        /* Nav & Chat Styles (Same as before) */
        .nav-tabs { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .nav-btn { padding: 8px 15px; border: none; background: #eee; border-radius: 20px; white-space: nowrap; cursor: pointer; font-size: 13px; }
        .nav-btn.active { background: var(--blue); color: white; }
        .chat-box { height: 300px; overflow-y: auto; background: var(--chat-bg); padding: 10px; border-radius: 8px; border: 1px solid #ddd; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 75%; font-size: 14px; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: #dcf8c6; } .msg.other { align-self: flex-start; background: white; }
        .hidden { display: none; }

        /* Call Modal */
        #call_modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; z-index: 9999; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .caller-anim { width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; animation: pulse 1s infinite; margin-bottom: 20px; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }

        /* Recaptcha container (Must be visible for first OTP) */
        #recaptcha-container { margin: 10px auto; }
    </style>
</head>
<body>

    <div id="call_modal">
        <div class="caller-anim">üìû</div>
        <h2 id="call_status">Connecting...</h2>
        <div style="display: flex; gap: 20px; margin-top: 20px;">
            <button class="btn btn-green" id="btn_answer" style="width: 120px; display:none;" onclick="answerCall()">Answer</button>
            <button class="btn btn-red" style="width: 120px;" onclick="endCall()">End</button>
        </div>
        <audio id="remote_audio" autoplay></audio>
    </div>

    <div class="container">
        <div id="box-login" class="box">
            <h2>üîê Login</h2>
            <div class="login-tabs">
                <div class="l-tab active" onclick="switchLogin('pass', this)">Password</div>
                <div class="l-tab" onclick="switchLogin('otp', this)">OTP</div>
            </div>

            <div id="login-pass-sec">
                <input type="text" id="l_phone" placeholder="Mobile Number (10 digit)">
                <input type="password" id="l_pass" placeholder="Password">
                <button class="btn btn-blue" onclick="doLoginPass()">Login</button>
            </div>

            <div id="login-otp-sec" class="hidden">
                <input type="text" id="l_otp_phone" placeholder="Mobile Number (10 digit)">
                <div id="l_otp_input_area" class="hidden">
                    <input type="number" id="l_otp_code" placeholder="Enter 6-digit OTP">
                    <button class="btn btn-green" onclick="verifyLoginOTP()">Verify & Login</button>
                </div>
                <button class="btn btn-blue" id="btn_l_send" onclick="sendLoginOTP()">Send OTP</button>
            </div>

            <div id="recaptcha-container"></div>

            <p style="text-align:center; margin-top:15px; font-size:13px;">
                <span onclick="go('box-reg')" style="color:var(--blue); cursor:pointer;">New User? Register Here</span>
            </p>
        </div>

        <div id="box-reg" class="box">
            <h2>üìù Registration</h2>
            <input type="text" id="r_name" placeholder="Full Name">
            <input type="text" id="r_phone" placeholder="Mobile Number (10 digit)">
            
            <div id="r_otp_sec" class="hidden" style="background:#f9f9f9; padding:10px; border-radius:5px;">
                <label style="font-size:12px; color:green;">OTP Sent!</label>
                <input type="number" id="r_otp_code" placeholder="Enter OTP">
                <button class="btn btn-green" onclick="verifyRegOTP()">Verify & Register</button>
            </div>

            <button class="btn btn-blue" id="btn_r_send" onclick="sendRegOTP()">Send OTP to Verify</button>
            
            <div id="r_pass_sec" class="hidden">
                <input type="password" id="r_pass" placeholder="Create Password">
                <button class="btn btn-green" onclick="finalizeReg()">Finish Registration</button>
            </div>

            <button class="btn" style="background:#888;" onclick="go('box-login')">Back</button>
        </div>

        <div id="box-user" class="box">
            <h3 id="wel_user">Welcome</h3>
            <div class="nav-tabs">
                <button class="nav-btn active" onclick="uTab('u-shop', this)">üõçÔ∏è Shop</button>
                <button class="nav-btn" onclick="uTab('u-chat', this)">üí¨ Chat Admin</button>
                <button class="nav-btn" onclick="uTab('u-media', this)">üì∫ Updates</button>
            </div>
            <div id="u-shop" class="u-sec">
                <select id="sel_p" onchange="calc()"></select>
                <input type="number" id="sel_qty" placeholder="Qty" oninput="calc()">
                <p id="total_p" style="font-size:20px; font-weight:bold; color:var(--green); text-align:center;">‚Çπ0</p>
                <input type="text" id="sel_ad" placeholder="Address">
                <button class="btn btn-green" onclick="placeOrder()">Order</button>
            </div>
            <div id="u-chat" class="u-sec hidden">
                <div class="chat-box" id="user_chat_box"></div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="text" id="u_msg_in" placeholder="Type...">
                    <button class="btn-blue" style="width:50px;" onclick="sendMsg('user')">‚û§</button>
                </div>
            </div>
            <div id="u-media" class="u-sec hidden"><div id="media_feed_user">Loading...</div></div>
            <button class="btn btn-red" onclick="location.reload()">Logout</button>
        </div>
    </div>

    <div id="box-admin" class="admin-wide">
        <h2>üõ†Ô∏è Admin Panel</h2>
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="aTab('a-orders', this)">Orders</button>
            <button class="nav-btn" onclick="aTab('a-users', this)">Users</button>
            <button class="nav-btn" onclick="aTab('a-prods', this)">Products</button>
            <button class="nav-btn" onclick="aTab('a-media', this)">Uploads</button>
        </div>
        <div id="a-orders" class="a-sec"><table id="tbl_o"><thead><tr><th>Order</th><th>Action</th></tr></thead><tbody></tbody></table></div>
        <div id="a-users" class="a-sec hidden">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <table id="tbl_u"><thead><tr><th>User</th><th>Action</th></tr></thead><tbody></tbody></table>
                <div>
                    <h4 id="adm_chat_head">Chat</h4>
                    <div class="chat-box" id="adm_chat_box"></div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input type="text" id="a_msg_in" placeholder="Reply...">
                        <button class="btn-blue" style="width:50px;" onclick="sendMsg('admin')">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="a-prods" class="a-sec hidden">
            <input type="text" id="p_name" placeholder="Name"> <input type="number" id="p_rate" placeholder="Rate">
            <button class="btn btn-green" onclick="addProd()">Add</button>
            <table id="tbl_p"><tbody></tbody></table>
        </div>
        <div id="a-media" class="a-sec hidden">
            <input type="text" id="m_title" placeholder="Title">
            <input type="text" id="m_vid" placeholder="YouTube Link">
            <button class="btn btn-blue" onclick="postMedia()">Post</button>
            <div id="adm_media_list"></div>
        </div>
        <button class="btn btn-red" onclick="location.reload()" style="display:block; margin:20px auto;">Logout</button>
    </div>

    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtLLOyVgt5hQwxokdsSRkeArZab5kyr_Q",
            authDomain: "mithilahelp-4107d.firebaseapp.com",
            databaseURL: "https://mithilahelp-4107d-default-rtdb.firebaseio.com",
            projectId: "mithilahelp-4107d",
            storageBucket: "mithilahelp-4107d.firebasestorage.app",
            messagingSenderId: "525345376934",
            appId: "1:525345376934:web:7083c7cecccd26a4a78267"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentUser = null, activeChatUser = null, confirmationResult = null;
        let products = {}, peer = null, currentCall = null;

        // --- AUTH & OTP SYSTEM ---
        window.onload = function() {
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'invisible'
            });
        };

        function switchLogin(type, el) {
            document.querySelectorAll('.l-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            if(type === 'pass') {
                document.getElementById('login-pass-sec').classList.remove('hidden');
                document.getElementById('login-otp-sec').classList.add('hidden');
            } else {
                document.getElementById('login-pass-sec').classList.add('hidden');
                document.getElementById('login-otp-sec').classList.remove('hidden');
            }
        }

        // 1. Password Login
        function doLoginPass() {
            let ph = document.getElementById('l_phone').value;
            let p = document.getElementById('l_pass').value;

            if(ph === "shreya rani" && p === "mydearshreya@#") {
                initAudio('admin_shreya'); loadAdmin(); go('box-admin'); return;
            }

            db.ref('users/' + ph).once('value', s => {
                let u = s.val();
                if(u && u.pass === p) {
                    currentUser = u;
                    initAudio('u_' + ph); loadUser(); go('box-user');
                } else alert("Wrong Password or User not found");
            });
        }

        // 2. Login Send OTP
        function sendLoginOTP() {
            let ph = document.getElementById('l_otp_phone').value;
            if(ph.length < 10) return alert("Valid Mobile Number required!");
            let fPhone = "+91" + ph;
            
            // Check if user exists first
            db.ref('users/' + ph).once('value', s => {
                if(!s.exists()) return alert("User not registered! Register first.");
                
                auth.signInWithPhoneNumber(fPhone, window.recaptchaVerifier)
                .then((cr) => {
                    confirmationResult = cr;
                    document.getElementById('l_otp_input_area').classList.remove('hidden');
                    document.getElementById('btn_l_send').classList.add('hidden');
                    alert("OTP Sent to " + fPhone);
                }).catch((error) => {
                    console.error(error); alert("SMS Error: " + error.message);
                });
            });
        }

        // 3. Verify Login OTP
        function verifyLoginOTP() {
            let code = document.getElementById('l_otp_code').value;
            confirmationResult.confirm(code).then((result) => {
                let ph = document.getElementById('l_otp_phone').value;
                db.ref('users/' + ph).once('value', s => {
                    currentUser = s.val();
                    initAudio('u_' + ph); loadUser(); go('box-user');
                });
            }).catch((error) => alert("Wrong OTP!"));
        }

        // 4. Registration OTP
        function sendRegOTP() {
            let n = document.getElementById('r_name').value;
            let ph = document.getElementById('r_phone').value;
            if(!n || ph.length < 10) return alert("Enter Name and valid Mobile");

            // Check if already registered
            db.ref('users/' + ph).once('value', s => {
                if(s.exists()) return alert("Already registered! Go to Login.");
                
                let fPhone = "+91" + ph;
                auth.signInWithPhoneNumber(fPhone, window.recaptchaVerifier)
                .then((cr) => {
                    confirmationResult = cr;
                    document.getElementById('r_otp_sec').classList.remove('hidden');
                    document.getElementById('btn_r_send').classList.add('hidden');
                    alert("OTP Sent!");
                }).catch((err) => alert("Error: " + err.message));
            });
        }

        function verifyRegOTP() {
            let code = document.getElementById('r_otp_code').value;
            confirmationResult.confirm(code).then((result) => {
                // OTP verified, now allow password creation
                document.getElementById('r_pass_sec').classList.remove('hidden');
                document.getElementById('r_otp_sec').style.display = 'none';
                alert("Mobile Verified! Now set a password.");
            }).catch((err) => alert("Invalid OTP"));
        }

        function finalizeReg() {
            let n = document.getElementById('r_name').value;
            let ph = document.getElementById('r_phone').value;
            let p = document.getElementById('r_pass').value;
            
            if(!p) return alert("Password is required");

            db.ref('users/' + ph).set({
                name: n, phone: ph, pass: p, verified: true
            }, (err) => {
                if(!err) { alert("Registration Success!"); go('box-login'); }
            });
        }

        // --- APP LOGIC (Simplified from previous) ---
        function go(id) {
            document.querySelectorAll('.box, .admin-wide').forEach(e => e.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        // User
        function loadUser() {
            document.getElementById('wel_user').innerText = "Namaste, " + currentUser.name;
            db.ref('products').on('value', s => {
                products = s.val() || {};
                let h = "<option value=''>Item</option>";
                for(let k in products) h += `<option value="${k}">${products[k].name} - ‚Çπ${products[k].rate}</option>`;
                document.getElementById('sel_p').innerHTML = h;
            });
            db.ref('chats/' + currentUser.phone).on('value', s => renderChat(s.val(), 'user_chat_box', 'user'));
            db.ref('posts').on('value', s => renderMedia(s.val()));
        }

        function placeOrder() {
            let pid = document.getElementById('sel_p').value, qty = document.getElementById('sel_qty').value, ad = document.getElementById('sel_ad').value;
            if(pid && qty && ad) {
                db.ref('orders').push({ phone:currentUser.phone, name:currentUser.name, item:products[pid].name, qty:qty, status:"Pending" });
                alert("Order Placed!");
            }
        }
        function calc() {
            let id = document.getElementById('sel_p').value, q = document.getElementById('sel_qty').value;
            if(id && q) document.getElementById('total_p').innerText = "‚Çπ" + (products[id].rate * q);
        }

        // Admin
        function loadAdmin() {
            db.ref('orders').on('value', s => {
                let d = s.val(), h = "";
                if(d) Object.keys(d).forEach(k => {
                    h += `<tr><td>${d[k].name} - ${d[k].item}<br><small>${d[k].status}</small></td>
                    <td><button onclick="db.ref('orders/${k}').remove()">X</button> <button onclick="db.ref('orders/${k}').update({status:'Confirmed'})">‚úî</button></td></tr>`;
                });
                document.getElementById('tbl_o').querySelector('tbody').innerHTML = h;
            });
            db.ref('users').on('value', s => {
                let d = s.val(), h = "";
                if(d) Object.keys(d).forEach(k => {
                    h += `<tr><td>${d[k].name}<br>${d[k].phone}</td><td><button onclick="makeCall('u_${d[k].phone}')">üìû</button> <button onclick="openChat('${d[k].phone}','${d[k].name}')">üí¨</button></td></tr>`;
                });
                document.getElementById('tbl_u').querySelector('tbody').innerHTML = h;
            });
            db.ref('products').on('value', s => {
                let d = s.val(), h = "";
                if(d) Object.keys(d).forEach(k => h += `<tr><td>${d[k].name}</td><td>${d[k].rate}</td></tr>`);
                document.getElementById('tbl_p').querySelector('tbody').innerHTML = h;
            });
            db.ref('posts').on('value', s => {
                let d = s.val(), h = "";
                if(d) Object.keys(d).forEach(k => h += `<div>${d[k].title} <span onclick="db.ref('posts/${k}').remove()" style="color:red;cursor:pointer;">[X]</span></div>`);
                document.getElementById('adm_media_list').innerHTML = h;
            });
        }
        function addProd() {
            let n = document.getElementById('p_name').value, r = document.getElementById('p_rate').value;
            if(n && r) db.ref('products').push({name:n, rate:r});
        }
        function postMedia() {
            let t = document.getElementById('m_title').value, v = document.getElementById('m_vid').value;
            if(t) db.ref('posts').push({title:t, url:v, type: v ? 'video':'text'});
        }

        // Chat
        function sendMsg(role) {
            let txt = document.getElementById(role == 'user' ? 'u_msg_in':'a_msg_in').value;
            let ph = role == 'user' ? currentUser.phone : activeChatUser;
            if(txt && ph) {
                db.ref('chats/'+ph).push({text:txt, sender:role});
                document.getElementById(role == 'user' ? 'u_msg_in':'a_msg_in').value = "";
            }
        }
        function renderChat(d, elId, role) {
            let box = document.getElementById(elId); box.innerHTML = "";
            if(d) Object.keys(d).forEach(k => {
                let m = d[k];
                box.innerHTML += `<div class="msg ${m.sender==role || (role=='admin' && m.sender=='admin') ? 'me':'other'}">${m.text}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        }
        function openChat(ph, n) {
            activeChatUser = ph; document.getElementById('adm_chat_head').innerText = n;
            db.ref('chats/'+ph).on('value', s => renderChat(s.val(), 'adm_chat_box', 'admin'));
        }

        // Media
        function renderMedia(d) {
            let h = "";
            if(d) Object.keys(d).reverse().forEach(k => {
                let m = d[k];
                let c = m.type=='video' ? `<iframe src="${m.url.replace('watch?v=','embed/')}" style="width:100%;height:200px;border:none;"></iframe>` : '';
                h += `<div style="background:white; padding:10px; margin-bottom:10px; border-radius:8px;"><b>${m.title}</b><br>${c}</div>`;
            });
            document.getElementById('media_feed_user').innerHTML = h;
        }

        // Navigation helpers
        function uTab(id, b) {
            document.querySelectorAll('.u-sec').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function aTab(id, b) {
            document.querySelectorAll('.a-sec').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // Audio
        function initAudio(id) {
            peer = new Peer(id);
            peer.on('call', c => {
                document.getElementById('call_modal').style.display = 'flex';
                document.getElementById('call_status').innerText = "üìû Admin Calling...";
                document.getElementById('btn_answer').style.display = 'block';
                currentCall = c;
            });
        }
        function makeCall(id) {
            document.getElementById('call_modal').style.display = 'flex';
            document.getElementById('call_status').innerText = "Calling...";
            document.getElementById('btn_answer').style.display = 'none';
            navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                let call = peer.call(id, s);
                currentCall = call;
                call.on('stream', rs => document.getElementById('remote_audio').srcObject = rs);
            });
        }
        function answerCall() {
            navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                currentCall.answer(s);
                document.getElementById('call_status').innerText = "Connected";
                document.getElementById('btn_answer').style.display = 'none';
                currentCall.on('stream', rs => document.getElementById('remote_audio').srcObject = rs);
            });
        }
        function endCall() { if(currentCall) currentCall.close(); document.getElementById('call_modal').style.display = 'none'; }
    </script>
</body>
</html>
