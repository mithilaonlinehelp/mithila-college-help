<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mithila Help - Super Admin System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --orange: #FF9933; --green: #138808; --blue: #007BFF; --red: #dc3545; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #f0f2f5; min-height: 100vh; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        .admin-card { max-width: 900px; background: #fff; padding: 20px; border-radius: 10px; margin: auto; }
        h2 { text-align: center; color: var(--green); margin-bottom: 20px; border-bottom: 2px solid var(--orange); padding-bottom: 10px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 30px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-blue { background: var(--blue); }
        .btn-red { background: var(--red); }
        .btn-green { background: var(--green); }
        .captcha { background: #eee; text-align: center; font-size: 20px; font-weight: bold; padding: 10px; border-radius: 8px; margin: 10px 0; letter-spacing: 3px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        table, th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f8f9fa; }
        .badge { padding: 4px 8px; border-radius: 5px; color: white; font-size: 11px; }
        .status-box { background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid #ffeeba; }
        #login-page, #register-page, #order-page, #admin-page { display: none; }
    </style>
</head>
<body>

    <div id="login-page" class="card" style="display:block;">
        <h2>üîê Secure Login</h2>
        <input type="text" id="l_user" placeholder="Mobile Number or Admin Username">
        <input type="password" id="l_pass" placeholder="Password">
        <div class="captcha" id="cap_box"></div>
        <input type="text" id="l_cap" placeholder="Enter Captcha Answer">
        <button class="btn btn-blue" onclick="handleLogin()">Login</button>
        <p style="text-align:center; margin-top:15px; font-size:14px;">Naye hain? <a href="#" onclick="showPage('register-page')">Register Karein</a></p>
    </div>

    <div id="register-page" class="card">
        <h2>üìù User Registration</h2>
        <input type="text" id="r_name" placeholder="Full Name">
        <input type="text" id="r_phone" placeholder="Mobile Number">
        <label style="font-size:12px;">Date of Birth:</label>
        <input type="date" id="r_dob">
        <input type="password" id="r_pass" placeholder="Create Password">
        <button class="btn btn-blue" onclick="handleRegister()">Register Now</button>
        <button class="btn" onclick="showPage('login-page')">Back to Login</button>
    </div>

    <div id="order-page" class="card">
        <h2 id="u_welcome">Welcome User</h2>
        <div id="tracking-info" class="status-box" style="display:none;"></div>
        <select id="o_prod" onchange="updateTotal()"></select>
        <input type="number" id="o_gram" placeholder="Quantity in Grams (Min 100)" oninput="updateTotal()">
        <p id="o_price" style="text-align:center; font-weight:bold; margin:10px 0;">Total: ‚Çπ0.00</p>
        <input type="text" id="o_addr" placeholder="Full Delivery Address">
        <button class="btn btn-green" onclick="submitOrder()">Place Order & Pay</button>
        <div id="qrcode" style="display:flex; justify-content:center; margin-top:15px;"></div>
        <button class="btn btn-blue" onclick="location.reload()">Logout</button>
    </div>

    <div id="admin-page" class="admin-card">
        <h2>üõ†Ô∏è Super Admin: Shreya Rani</h2>
        
        <div style="background:#f8f9fa; padding:15px; border-radius:10px;">
            <h4>Add/Update Product</h4>
            <input type="text" id="p_name" placeholder="Product Name">
            <input type="number" id="p_rate" placeholder="Rate per KG">
            <button class="btn btn-blue" onclick="addUpdateProduct()">Save Product</button>
            <div id="prod_list" style="margin-top:10px;"></div>
        </div>

        <h3>üë• Registered Users</h3>
        <table id="user_table">
            <thead><tr><th>Name</th><th>Phone</th><th>DOB</th><th>Password</th><th>Action</th></tr></thead>
            <tbody></tbody>
        </table>

        <h3>üì¶ Orders & Tracking</h3>
        <table id="order_table">
            <thead><tr><th>Order ID</th><th>Customer</th><th>Item</th><th>Status</th><th>Delivery Time</th><th>Update</th></tr></thead>
            <tbody></tbody>
        </table>

        <button class="btn btn-red" onclick="location.reload()">Logout Admin</button>
    </div>

    <script>
        let correctCap = 0;
        let currentUser = null;
        
        // Database Initialization
        let db = JSON.parse(localStorage.getItem('mch_db')) || {
            users: [],
            products: [
                {name: "Packet A", rate: 9300},
                {name: "Packet B", rate: 11700},
                {name: "Packet C", rate: 5500}
            ],
            orders: [],
            blocked: []
        };

        function saveDB() { localStorage.setItem('mch_db', JSON.stringify(db)); }

        function genCap() {
            let a = Math.floor(Math.random()*10), b = Math.floor(Math.random()*10);
            correctCap = a + b;
            document.getElementById('cap_box').innerText = `${a} + ${b} = ?`;
        }

        function showPage(id) {
            document.querySelectorAll('div[id$="-page"]').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'login-page') genCap();
        }

        function handleLogin() {
            let u = document.getElementById('l_user').value;
            let p = document.getElementById('l_pass').value;
            let c = document.getElementById('l_cap').value;

            if(c != correctCap) return alert("Captcha Galat Hai!");

            // Admin Login
            if(u === "shreya rani" && p === "mydearshreya@#") {
                loadAdmin();
                showPage('admin-page');
                return;
            }

            // User Login
            if(db.blocked.includes(u)) return alert("Aapka account block kar diya gaya hai!");
            let user = db.users.find(x => x.phone === u && x.pass === p);
            if(user) {
                currentUser = user;
                loadUserOrderPage();
                showPage('order-page');
            } else alert("Invalid Details!");
        }

        function handleRegister() {
            let n = document.getElementById('r_name').value, ph = document.getElementById('r_phone').value,
                d = document.getElementById('r_dob').value, ps = document.getElementById('r_pass').value;
            if(!n || ph.length < 10 || !d || !ps) return alert("Sari jankari bharen!");
            db.users.push({name: n, phone: ph, dob: d, pass: ps});
            saveDB();
            alert("Registration Success!");
            showPage('login-page');
        }

        // --- USER FUNCTIONS ---
        function loadUserOrderPage() {
            document.getElementById('u_welcome').innerText = `Namaste, ${currentUser.name}`;
            let sel = document.getElementById('o_prod');
            sel.innerHTML = `<option value="">-- Choose Product --</option>`;
            db.products.forEach(p => sel.innerHTML += `<option value="${p.rate}">${p.name} (‚Çπ${p.rate}/kg)</option>`);
            
            // Show Tracking if order exists
            let myOrder = db.orders.reverse().find(o => o.phone === currentUser.phone);
            if(myOrder) {
                document.getElementById('tracking-info').style.display = 'block';
                document.getElementById('tracking-info').innerHTML = `<b>Order Status:</b> ${myOrder.status}<br><b>Delivery Time:</b> ${myOrder.eta || 'Calculating...'}`;
            }
        }

        function updateTotal() {
            let rate = document.getElementById('o_prod').value, gram = document.getElementById('o_gram').value;
            if(rate && gram >= 100) {
                let total = (rate / 1000) * gram;
                document.getElementById('o_price').innerText = `Total: ‚Çπ${total.toFixed(2)}`;
            }
        }

        function submitOrder() {
            let prodName = document.getElementById('o_prod').options[document.getElementById('o_prod').selectedIndex].text;
            let gram = document.getElementById('o_gram').value, addr = document.getElementById('o_addr').value;
            let price = document.getElementById('o_price').innerText.split('‚Çπ')[1];
            if(!gram || !addr) return alert("Details bharen!");

            let orderID = "ORD" + Math.floor(Math.random()*9000);
            db.orders.push({id: orderID, name: currentUser.name, phone: currentUser.phone, item: prodName, gram: gram, price: price, addr: addr, status: 'Pending', eta: ''});
            saveDB();

            let upi = `upi://pay?pa=7033578145@sbi&pn=MithilaHelp&am=${price}&cu=INR&tn=${orderID}`;
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById('qrcode'), {text: upi, width:150, height:150});
            alert("Order Placed! Please Pay.");
        }

        // --- ADMIN FUNCTIONS ---
        function loadAdmin() {
            // Load Users
            let ut = document.querySelector('#user_table tbody'); ut.innerHTML = "";
            db.users.forEach(u => {
                let isBlocked = db.blocked.includes(u.phone);
                ut.innerHTML += `<tr><td>${u.name}</td><td>${u.phone}</td><td>${u.dob}</td><td>${u.pass}</td>
                <td><button onclick="toggleBlock('${u.phone}')" class="btn" style="background:${isBlocked?'green':'red'}; padding:5px; font-size:10px;">${isBlocked?'Unblock':'Block'}</button></td></tr>`;
            });

            // Load Orders
            let ot = document.querySelector('#order_table tbody'); ot.innerHTML = "";
            db.orders.forEach((o, i) => {
                ot.innerHTML += `<tr><td>${o.id}</td><td>${o.name} (${o.phone})</td><td>${o.item}</td>
                <td><select onchange="updateStatus(${i}, this.value)"><option ${o.status=='Pending'?'selected':''}>Pending</option><option ${o.status=='Packing'?'selected':''}>Packing</option><option ${o.status=='On the way'?'selected':''}>On the way</option><option ${o.status=='Delivered'?'selected':''}>Delivered</option></select></td>
                <td><input type="text" placeholder="e.g. 2 Hours" value="${o.eta}" onchange="updateETA(${i}, this.value)"></td>
                <td><button onclick="saveAdminChanges()">Save</button></td></tr>`;
            });
        }

        function toggleBlock(ph) {
            if(db.blocked.includes(ph)) db.blocked = db.blocked.filter(x => x !== ph);
            else db.blocked.push(ph);
            saveDB(); loadAdmin();
        }

        function updateStatus(i, val) { db.orders[i].status = val; }
        function updateETA(i, val) { db.orders[i].eta = val; }
        function saveAdminChanges() { saveDB(); alert("Data Updated!"); }

        function addUpdateProduct() {
            let n = document.getElementById('p_name').value, r = document.getElementById('p_rate').value;
            if(!n || !r) return;
            db.products.push({name: n, rate: r});
            saveDB(); loadAdmin(); alert("Product Added!");
        }

        window.onload = genCap;
    </script>
</body>
</html>
