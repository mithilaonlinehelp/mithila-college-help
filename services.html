<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Mithila System (Connected)</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        /* --- DESIGN & RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; 
            min-height: 100vh;
            background: linear-gradient(180deg, #FF9933 0%, #ffffff 40%, #ffffff 60%, #138808 100%);
            padding-bottom: 50px;
            overflow-x: hidden;
        }

        /* --- BACKGROUND CHAKRA (Fixed) --- */
        .chakra-bg {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 280px; height: 280px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23000080' stroke-width='1'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cpath d='M12 2v20M2 12h20M4.93 4.93l14.14 14.14M19.07 4.93L4.93 19.07M12 12l2.5-4.33M12 12l-2.5-4.33M12 12l4.33 2.5M12 12l-4.33 2.5M12 12l4.33-2.5M12 12l-4.33-2.5M12 12l2.5 4.33M12 12l-2.5 4.33'/%3E%3C/svg%3E");
            background-size: contain;
            opacity: 0.15;
            z-index: 0; 
            pointer-events: none; /* Clicks will pass through */
            animation: spin 20s linear infinite;
        }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* --- CONTAINER --- */
        .container {
            position: relative; z-index: 999;
            max-width: 450px; margin: 10px auto; padding: 15px;
        }

        /* --- BOX STYLES --- */
        .box {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px; padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-top: 5px solid #000080;
            display: none; 
        }
        .box.active { display: block; }

        h2, h3 { text-align: center; color: #000080; margin: 0 0 15px 0; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }

        /* --- BUTTONS --- */
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 25px;
            font-size: 16px; font-weight: bold; color: white; cursor: pointer;
            margin-top: 10px; transition: 0.2s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        .btn:active { transform: scale(0.95); }
        .btn-blue { background: #000080; }
        .btn-green { background: #138808; }
        .btn-orange { background: #FF9933; }
        .btn-red { background: #dc3545; }

        .nav-tabs { display: flex; gap: 5px; margin-bottom: 15px; justify-content: center; background: #eee; padding: 5px; border-radius: 25px; }
        .tab { padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: bold; color: #555; }
        .tab.active { background: #000080; color: white; }

        #cam_wrapper { text-align: center; display: none; margin-top: 10px; }
        video { width: 100%; border-radius: 10px; background: black; }
        .list-item { background: #fff; padding: 10px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid #138808; display:flex; justify-content:space-between; align-items:center; }
        .hidden { display: none !important; }
        
        #recaptcha-container { margin: 10px auto; text-align: center; }
    </style>
</head>
<body>

    <div class="chakra-bg"></div>

    <div class="container">
        
        <div id="view-login" class="box active">
            <h2>üîê Login Panel</h2>
            <div class="nav-tabs">
                <div class="tab active" onclick="setTab('user', this)">User</div>
                <div class="tab" onclick="setTab('emp', this)">Employee</div>
                <div class="tab" onclick="setTab('admin', this)">Admin</div>
            </div>

            <div id="login_form">
                <input type="number" id="l_phone" placeholder="Mobile Number (10 digit)">
                
                <div id="pass_area">
                    <input type="password" id="l_pass" placeholder="Password">
                    <button class="btn btn-blue" onclick="loginPass()">Login with Password</button>
                    <p style="text-align:center; font-size:12px; margin-top:10px; color:#000080; cursor:pointer;" onclick="toggleLoginMethod('otp')">Or Login via OTP</p>
                </div>

                <div id="otp_area" class="hidden">
                    <button class="btn btn-orange" id="btn_send_l_otp" onclick="sendLoginOTP()">Send OTP</button>
                    <div id="verify_l_otp_div" class="hidden">
                        <input type="number" id="l_otp_code" placeholder="Enter 6-digit OTP">
                        <button class="btn btn-green" onclick="verifyLoginOTP()">Verify & Login</button>
                    </div>
                    <p style="text-align:center; font-size:12px; margin-top:10px; color:#000080; cursor:pointer;" onclick="toggleLoginMethod('pass')">Back to Password</p>
                </div>
            </div>

            <div id="admin_form" class="hidden">
                <input type="text" id="a_id" placeholder="Admin ID">
                <input type="password" id="a_pass" placeholder="Password">
                <button class="btn btn-orange" onclick="loginAdmin()">Login Admin</button>
            </div>

            <div id="recaptcha-container"></div>

            <p id="reg_link" style="text-align:center; margin-top:15px;">
                <span onclick="showReg()" style="color:#FF9933; font-weight:bold; cursor:pointer;">New Registration? Click Here</span>
            </p>
        </div>

        <div id="view-reg" class="box">
            <h2>üìù Register</h2>
            <select id="r_type">
                <option value="user">User</option>
                <option value="employee">Employee</option>
            </select>
            <input type="text" id="r_name" placeholder="Full Name">
            <input type="text" id="r_email" placeholder="Email">
            <input type="number" id="r_phone" placeholder="Mobile Number">
            
            <button class="btn btn-blue" id="btn_r_send" onclick="sendRegOTP()">Send OTP to Verify</button>
            
            <div id="r_otp_sec" class="hidden">
                <input type="number" id="r_otp_code" placeholder="Enter OTP">
                <button class="btn btn-green" onclick="verifyRegOTP()">Verify OTP</button>
            </div>

            <div id="r_pass_sec" class="hidden">
                <input type="password" id="r_pass" placeholder="Set Password">
                <button class="btn btn-blue" onclick="finalizeReg()">Finish Registration</button>
            </div>

            <button class="btn btn-red" onclick="showLogin()">Cancel</button>
        </div>

        <div id="view-emp" class="box">
            <h3 id="emp_welcome">Employee</h3>
            
            <div style="background:#f9f9f9; padding:10px; border-radius:10px; text-align:center; border:1px solid #ddd;">
                <p id="att_msg" style="font-weight:bold;">Checking Attendance...</p>
                <div id="cam_wrapper">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                    <button class="btn btn-green" onclick="snapAndPunch()">üì∏ Capture & Punch</button>
                </div>
                <button class="btn btn-blue" id="btn_cam" onclick="startCamera()">Start Face Punching</button>
            </div>

            <hr>
            <textarea id="work_rpt" placeholder="Work Report..."></textarea>
            <button class="btn btn-orange" onclick="submitReport()">Send Report</button>
            <button class="btn btn-red" onclick="logout()">Logout</button>
        </div>

        <div id="view-admin" class="box">
            <h2>üõ†Ô∏è Admin Panel</h2>
            <div class="nav-tabs">
                <div class="tab active" onclick="admTab('a-emp')">Employees</div>
                <div class="tab" onclick="admTab('a-media')">Uploads</div>
            </div>

            <div id="a-emp">
                <h4>Employee List & Instant Punch</h4>
                <div id="admin_emp_list">Loading...</div>
            </div>

            <div id="a-media" class="hidden">
                <h4>Upload Feed</h4>
                <input type="text" id="m_title" placeholder="Title">
                <input type="text" id="m_url" placeholder="Video/Photo URL">
                <select id="m_type"><option value="video">Video</option><option value="photo">Photo</option></select>
                <button class="btn btn-orange" onclick="uploadMedia()">Post</button>
            </div>
            
            <button class="btn btn-red" onclick="logout()">Logout</button>
        </div>

        <div id="view-user" class="box">
            <h3 id="user_welcome">Welcome</h3>
            <div id="media_feed">Loading...</div>
            <button class="btn btn-red" onclick="logout()">Logout</button>
        </div>

    </div>

    <script>
        // --- 1. YOUR FIREBASE KEYS (Extracted from Screenshot) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtLLOyVgt5hQwxokdsSRkeArZab5kyr_Q", 
            authDomain: "mithilahelp-4107d.firebaseapp.com",
            databaseURL: "https://mithilahelp-4107d-default-rtdb.firebaseio.com",
            projectId: "mithilahelp-4107d",
            storageBucket: "mithilahelp-4107d.firebasestorage.app",
            messagingSenderId: "525345376934",
            appId: "1:525345376934:web:7083c7cecccd26a4a78267",
            measurementId: "G-56QQ58B15G"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // Global Vars
        let currentUser = null;
        let confirmResult = null;
        let currentRole = 'user';

        // Init ReCaptcha
        window.onload = function() {
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'invisible'
            });
        }

        // --- NAVIGATION & TABS ---
        function switchView(id) {
            document.querySelectorAll('.box').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function setTab(role, btn) {
            currentRole = role;
            document.querySelectorAll('.nav-tabs .tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            if(role === 'admin') {
                document.getElementById('login_form').classList.add('hidden');
                document.getElementById('admin_form').classList.remove('hidden');
                document.getElementById('reg_link').style.display = 'none';
            } else {
                document.getElementById('login_form').classList.remove('hidden');
                document.getElementById('admin_form').classList.add('hidden');
                document.getElementById('reg_link').style.display = 'block';
            }
        }
        function toggleLoginMethod(method) {
            if(method === 'otp') {
                document.getElementById('pass_area').classList.add('hidden');
                document.getElementById('otp_area').classList.remove('hidden');
            } else {
                document.getElementById('pass_area').classList.remove('hidden');
                document.getElementById('otp_area').classList.add('hidden');
            }
        }
        function showReg() { switchView('view-reg'); }
        function showLogin() { switchView('view-login'); }
        function logout() { location.reload(); }
        function admTab(id) {
            document.getElementById('a-emp').classList.add('hidden');
            document.getElementById('a-media').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        }

        // --- LOGIN LOGIC ---
        function loginPass() {
            let ph = document.getElementById('l_phone').value;
            let pa = document.getElementById('l_pass').value;
            if(!ph || !pa) return alert("Phone & Pass required");

            let path = currentRole === 'emp' ? 'employees/' : 'users/';
            db.ref(path + ph).once('value', s => {
                let d = s.val();
                if(d && d.pass === pa) {
                    enterDashboard(d);
                } else alert("User not found or Wrong Password");
            });
        }

        function loginAdmin() {
            let i = document.getElementById('a_id').value;
            let p = document.getElementById('a_pass').value;
            if(i === "shreya rani" && p === "mydearshreya@#") {
                currentUser = { name: "Admin Shreya", role: 'admin' };
                loadAdminData();
                switchView('view-admin');
            } else alert("Galat ID/Pass");
        }

        function sendLoginOTP() {
            let ph = document.getElementById('l_phone').value;
            if(ph.length < 10) return alert("Valid mobile number dalein");
            let path = currentRole === 'emp' ? 'employees/' : 'users/';
            
            db.ref(path + ph).once('value', s => {
                if(!s.exists()) return alert("Not Registered! Please Register first.");
                auth.signInWithPhoneNumber('+91'+ph, window.recaptchaVerifier)
                .then(cr => {
                    confirmResult = cr;
                    document.getElementById('btn_send_l_otp').classList.add('hidden');
                    document.getElementById('verify_l_otp_div').classList.remove('hidden');
                    alert("OTP Sent to " + ph);
                }).catch(e => alert("SMS Error: " + e.message));
            });
        }

        function verifyLoginOTP() {
            let code = document.getElementById('l_otp_code').value;
            confirmResult.confirm(code).then(res => {
                let ph = document.getElementById('l_phone').value;
                let path = currentRole === 'emp' ? 'employees/' : 'users/';
                db.ref(path + ph).once('value', s => enterDashboard(s.val()));
            }).catch(e => alert("Wrong OTP"));
        }

        function enterDashboard(user) {
            currentUser = user;
            if(currentRole === 'emp') {
                document.getElementById('emp_welcome').innerText = "Hi, " + user.name;
                checkAttendance();
                switchView('view-emp');
            } else {
                document.getElementById('user_welcome').innerText = "Namaste, " + user.name;
                loadFeed();
                switchView('view-user');
            }
        }

        // --- REGISTRATION ---
        function sendRegOTP() {
            let ph = document.getElementById('r_phone').value;
            if(ph.length < 10) return alert("Valid Mobile Number Required");
            let type = document.getElementById('r_type').value;
            let path = type === 'employee' ? 'employees/' : 'users/';
            
            db.ref(path + ph).once('value', s => {
                if(s.exists()) return alert("Already Registered!");
                auth.signInWithPhoneNumber('+91'+ph, window.recaptchaVerifier)
                .then(cr => {
                    confirmResult = cr;
                    document.getElementById('btn_r_send').classList.add('hidden');
                    document.getElementById('r_otp_sec').classList.remove('hidden');
                    alert("OTP Sent!");
                }).catch(e => alert(e.message));
            });
        }

        function verifyRegOTP() {
            let code = document.getElementById('r_otp_code').value;
            confirmResult.confirm(code).then(res => {
                document.getElementById('r_otp_sec').classList.add('hidden');
                document.getElementById('r_pass_sec').classList.remove('hidden');
                alert("Mobile Verified! Create Password.");
            }).catch(e => alert("Wrong OTP"));
        }

        function finalizeReg() {
            let type = document.getElementById('r_type').value;
            let d = {
                name: document.getElementById('r_name').value,
                email: document.getElementById('r_email').value,
                phone: document.getElementById('r_phone').value,
                pass: document.getElementById('r_pass').value,
                role: type
            };
            let path = type === 'employee' ? 'employees/' : 'users/';
            db.ref(path + d.phone).set(d, e => {
                if(!e) { alert("Registration Success!"); showLogin(); }
            });
        }

        // --- EMPLOYEE FEATURES ---
        function checkAttendance() {
            let today = new Date().toLocaleDateString().split('/').join('-');
            db.ref('attendance/'+today+'/'+currentUser.phone).once('value', s => {
                if(s.exists()) {
                    document.getElementById('att_msg').innerHTML = "<b style='color:green'>‚úÖ Present (" + s.val().time + ")</b>";
                    document.getElementById('btn_cam').classList.add('hidden');
                } else {
                    document.getElementById('att_msg').innerHTML = "<b style='color:red'>‚ùå Not Punched</b>";
                    document.getElementById('btn_cam').classList.remove('hidden');
                }
            });
        }
        function startCamera() {
            document.getElementById('cam_wrapper').style.display = 'block';
            document.getElementById('btn_cam').classList.add('hidden');
            navigator.mediaDevices.getUserMedia({video: true}).then(s => {
                document.getElementById('video').srcObject = s;
            });
        }
        function snapAndPunch() {
            let v = document.getElementById('video');
            let c = document.getElementById('canvas');
            c.width = v.videoWidth; c.height = v.videoHeight;
            c.getContext('2d').drawImage(v,0,0);
            let img = c.toDataURL('image/png');
            let today = new Date().toLocaleDateString().split('/').join('-');
            
            db.ref('attendance/'+today+'/'+currentUser.phone).set({
                name: currentUser.name, time: new Date().toLocaleTimeString(), photo: img, punchedBy: 'Self'
            }, e => {
                if(!e) {
                    alert("Attendance Marked!");
                    v.srcObject.getTracks().forEach(t=>t.stop());
                    document.getElementById('cam_wrapper').style.display = 'none';
                    checkAttendance();
                }
            });
        }
        function submitReport() {
            let t = document.getElementById('work_rpt').value;
            let today = new Date().toLocaleDateString().split('/').join('-');
            if(t) db.ref('reports/'+today+'/'+currentUser.phone).push({text:t});
            alert("Sent!");
        }

        // --- ADMIN & FEED ---
        function loadAdminData() {
            db.ref('employees').on('value', s => {
                let h = "";
                s.forEach(snap => {
                    let e = snap.val();
                    h += `<div class="list-item">
                        <div><b>${e.name}</b><br>${e.phone}</div>
                        <button class="btn-blue" style="width:auto; padding:5px 10px; margin:0;" onclick="adminPunch('${e.phone}','${e.name}')">Punch</button>
                    </div>`;
                });
                document.getElementById('admin_emp_list').innerHTML = h;
            });
        }
        function adminPunch(ph, nm) {
            if(confirm("Mark " + nm + " Present?")) {
                let today = new Date().toLocaleDateString().split('/').join('-');
                db.ref('attendance/'+today+'/'+ph).set({
                    name: nm, time: new Date().toLocaleTimeString(), photo: 'AdminManual', punchedBy: 'Admin'
                }, e => alert("Done"));
            }
        }
        function uploadMedia() {
            let t=document.getElementById('m_title').value;
            let u=document.getElementById('m_url').value;
            let type=document.getElementById('m_type').value;
            db.ref('posts').push({title:t, url:u, type:type, date:new Date().toLocaleDateString()}, e=>alert("Posted"));
        }
        function loadFeed() {
            db.ref('posts').limitToLast(10).on('value', s => {
                let h = "";
                let a = []; s.forEach(x => a.push(x.val()));
                a.reverse().forEach(p => {
                    let media = p.type==='video' ? `<iframe src="${p.url.replace('watch?v=','embed/')}" style="width:100%;height:200px;border:none;"></iframe>` : `<img src="${p.url}" style="width:100%;">`;
                    h += `<div style="background:white; padding:10px; margin-bottom:10px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                        <b style="color:#FF9933">${p.title}</b><br><small>${p.date}</small><br>${media}
                    </div>`;
                });
                document.getElementById('media_feed').innerHTML = h;
            });
        }
    </script>
</body>
</html>
